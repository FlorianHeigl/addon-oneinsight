<!DOCTYPE html>
<html lang="en">
  <head>
  <title>ONE Insight - Host Usage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <script type="text/javascript" src="js/raphael-min.js"></script>
    <script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css" media="screen">
    <link rel="stylesheet" href="css/bootswatch.min.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../bower_components/html5shiv/dist/html5shiv.js"></script>
      <script src="../bower_components/respond/dest/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="../" class="navbar-brand">Rohol</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav">
          <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="themes">Nodes <span class="caret"></span></a>
            <ul class="dropdown-menu" aria-labelledby="themes">
              <li><a tabindex="-1" href="../default/">Default</a></li>
            </ul>
          </li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
          <li><a href="help.html">Help</a></li>
          </ul>

        </div>
      </div>
    </div>

<div class="container">
  <div class="page-header"><h1>ONE's Resource Usage</h1></div>
  <div id="node-load-container" class="pull-left"></div>
  <div id="loading-container" class="pull-right"></div>
</div>

        <!-- a script that create's a paper and a rectangle -->
<script type="text/javascript">

function drawHostLoadMap(xmlRpcResponse)
{
  var xmlRawData = $(xmlRpcResponse).find('methodResponse').find('data').eq(0);

  if ($(xmlRawData).find('boolean').text() == 1)
  {
    var HOST_INIT                 = 0; // Initial state for enabled hosts
    var HOST_MONITORING_MONITORED = 1; // Monitoring the host (from monitored)
    var HOST_MONITORED            = 2; // The host has been successfully monitored
    var HOST_ERROR                = 3; // An error ocurrer while monitoring the host
    var HOST_DISABLED             = 4; // The host is disabled won't be monitored
    var HOST_MONITORING_ERROR     = 5; // Monitoring the host (from error)
    var HOST_MONITORING_INIT      = 6; // Monitoring the host (from init)
    var HOST_MONITORING_DISABLED  = 7; // Monitoring the host (from disabled)

    var DRAWING_AREA = new Object();
        DRAWING_AREA.width = 750,
        DRAWING_AREA.height = '100%';

    var BASE_SHAPE_INFO = new Object();
        BASE_SHAPE_INFO.unit = 10,
        BASE_SHAPE_INFO.margin = 2;
        BASE_SHAPE_INFO.node_margin = 4;

    var curPos = new Object();
        curPos.x = BASE_SHAPE_INFO.node_margin,
         curPos.y = BASE_SHAPE_INFO.node_margin;

    var raphaelPaper = Raphael("node-load-container", DRAWING_AREA.width, DRAWING_AREA.height);

    $( $.parseXML( $(xmlRawData).find('string').text() ) ).find('HOST').each(
      function()
      {
        var nodeInfo = new Object();
        var nbRow = 1;
        var nbCol = 1;
        var maxNodeheight = nbRow;

        nodeInfo.maxCpu = parseInt($(this).find('MAX_CPU').text());
        nodeInfo.nbCpu = Math.ceil( nodeInfo.maxCpu / 100);
        switch(nodeInfo.nbCpu) {
          case 1:
            nbRow = 1;
          break;
          case 2:
          case 4:
            nbRow = 2;
          break;
          case 6:
          case 12:
            nbRow = 6;
          case 8:
          case 16:
            nbRow = 4;
          break;
          default:
            if (nodeInfo.nbCpu % 4 == 0)
              nbRow = 4;
            else if (nodeInfo.nbCpu % 6 == 0)
              nbRow = 6;
            else if (nodeInfo.nbCpu % 8 == 0)
              nbRow = 8;
            else
              nbRow = Math.ceil(nodeInfo.nbCpu);
          break;
          } // end switch(nodeInfo.nbCpu)

          nbCol = Math.ceil(nodeInfo.nbCpu / nbRow);

          var curNodeShape = new Object();
            curNodeShape.width  = nbCol * BASE_SHAPE_INFO.unit + (nbCol - 1) * BASE_SHAPE_INFO.margin;
            curNodeShape.height = nbRow * BASE_SHAPE_INFO.unit + (nbRow - 1) * BASE_SHAPE_INFO.margin;
            maxNodeheight = Math.max(maxNodeheight, curNodeShape.height);

          if (curPos.x + curNodeShape.width > DRAWING_AREA.width) {
            curPos.y += maxNodeheight + BASE_SHAPE_INFO.node_margin;
            curPos.x = BASE_SHAPE_INFO.node_margin;
            maxNodeheight = curNodeShape.height;
          } // end if (curPos.x + curNodeShape.width > DRAWING_AREA.width)

          nodeInfo.name = $(this).find('HOSTNAME').text();
          nodeInfo.state = parseInt( $(this).find('STATE').text() );
          nodeInfo.cpuUsed = parseInt( $(this).find('USED_CPU').text() );
          nodeInfo.cpuUsage = parseInt( $(this).find('CPU_USAGE').text() );
          nodeInfo.runningVms = parseInt( $(this).find('RUNNING_VMS').text() );
          nodeInfo.hypervisor = $(this).find('VM_MAD').text();

          nodeInfo.tooltip = 'Host: '+nodeInfo.name;
          nodeInfo.tooltip += '\nState: '+nodeInfo.state;
          nodeInfo.tooltip += '\nCPU: '+nodeInfo.nbCpu;
          nodeInfo.tooltip += '\n   Used: '+Math.ceil(nodeInfo.cpuUsed / nodeInfo.maxCpu) + '%';
          nodeInfo.tooltip += '\n   Used by VMs: '+ Math.ceil(nodeInfo.cpuUsage / nodeInfo.maxCpu) + '%';
          nodeInfo.tooltip += '\nRunning VMs: '+nodeInfo.runningVms;
          nodeInfo.tooltip += '\nHypervisor: '+nodeInfo.hypervisor;

          switch (nodeInfo.state) {
            case HOST_MONITORED:
            case HOST_MONITORING_MONITORED:
              var hostLoad = nodeInfo.cpuUsed / nodeInfo.maxCpu
              if (hostLoad ==0)
                nodeInfo.color = '#6699cc';              // dark blue
              else if (hostLoad <=25)
                nodeInfo.color = '#66ffcc';              // turquoise
              else if (hostLoad <=50)
                nodeInfo.color = '#ffff00';  // yellow
              else if (hostLoad <=75)
              nodeInfo.color = '#ff9900';               //light orange
              else
                nodeInfo.color = 'ff6600';              // dark orange
            break;
            case HOST_ERROR:
            case HOST_MONITORING_ERROR:
              nodeInfo.color = 'ff0000';                //red
            break;
            case HOST_INIT:
            case HOST_DISABLED:
            case HOST_MONITORING_INIT:
            case HOST_MONITORING_DISABLED:
              nodeInfo.color = '#c0c0c0';               // gray
            break;
          } // end switch (nodeInfo.state)

          nodeInfo.shape = raphaelPaper.set();
          for (var index=0; index< nodeInfo.nbCpu; ++index) {
            var curShape = raphaelPaper.rect(curPos.x + Math.floor(index / nbRow) * (BASE_SHAPE_INFO.unit + BASE_SHAPE_INFO.margin),
                                curPos.y + (index % nbRow) * (BASE_SHAPE_INFO.unit + BASE_SHAPE_INFO.margin),
                                BASE_SHAPE_INFO.unit,
                                BASE_SHAPE_INFO.unit);
            curShape.attr({fill: nodeInfo.color, 'stroke-width': 0});
            curShape.attr({title: nodeInfo.tooltip});
            nodeInfo.shape.push(curShape);
          }
          curPos.x += curNodeShape.width + BASE_SHAPE_INFO.node_margin;

      });  // end for each host
  } // end if ($(xmlRawData).find('boolean').text() == 1)
}

function refreshMap()
{
  console.log("refreshing the map2...");
  $.ajax({
    type: "GET",
    url: "onehost.xml",
    dataType: "xml",
    success: drawHostLoadMap
  });
}

(function($)
{
    $(document).ready(function()
    {
        $.ajaxSetup(
        {
          cache: false,
          beforeSend: function() {
              $('#node-load-container').hide();
              $('#loading-container').show();
          },
          complete: function() {
              $('#loading-container').hide();
              $('#node-load-container').show();
          },
          success: function() {
              $('#loading-container').hide();
              $('#node-load-container').show();
          }
        });
        var $container = $("#node-load-container");
        refreshMap();
        var refreshId = setInterval(function() {refreshMap;}, 2000);
    });
})(jQuery);

</script>

      <footer>
        <div class="row">
          <div class="col-lg-12">
          <ul class="list-unstyled">
            <li><a href="https://twitter.com/realopinsight">Twitter</a></li>
            <li><a href="https://github.com/rchakode/realopinsight/">GitHub</a></li>
            <li><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=F22JEM3Q78JC2">Donate</a></li>
          </ul>
          <p>Made by <a href="http://realopinsight.com">Rodrigue Chakode</a>. Code licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache
License v2.0</a>.</p>
          </div>
        </div>
      </footer>
    </div>

    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootswatch.js"></script>
  </body>
</html>
